<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survival RPG</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="style.css">
    <style>
        /* â”€â”€ Layout de pantalla â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        body { margin: 0; padding: 0; background: #060910; overflow: hidden; }
        #screen-wrapper {
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            display: flex; align-items: center; justify-content: center;
        }
        #game-wrapper {
            position: relative; width: 1280px; height: 720px;
            transform-origin: center center;
        }

        /* â”€â”€ Grilla de inventario â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #inventory-grid {
            display: grid;
            grid-template-columns: repeat(5, 45px);
            gap: 6px;
            justify-content: center;
            margin-bottom: 10px;
        }

        /* â”€â”€ Barras de label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .bar-wrapper { margin-bottom: 2px; }

        /* â”€â”€ Servidor guardados â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #saved-servers {
            margin-top: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
            max-height: 80px;
            overflow-y: auto;
        }
        #saved-servers::-webkit-scrollbar { width: 3px; }
        #saved-servers::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

        /* â”€â”€ Separador decorativo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .menu-sep {
            border: none;
            border-top: 1px solid rgba(255,255,255,0.07);
            margin: 14px 0;
        }
    </style>
</head>
<body>

<div id="screen-wrapper">
    <div id="game-wrapper">

        <div id="main-menu">
            <div style="display:flex; gap:0; width:820px; max-width:96vw; height:auto;
                        background:linear-gradient(155deg,rgba(9,15,23,0.99) 0%,rgba(5,9,15,0.995) 100%);
                        border:1px solid rgba(255,255,255,0.08); border-radius:14px;
                        box-shadow:0 0 0 1px rgba(255,255,255,0.03),0 40px 80px rgba(0,0,0,0.85),0 0 60px rgba(61,220,132,0.04);
                        overflow:hidden;">

                <div style="width:310px;flex-shrink:0;padding:28px 24px;border-right:1px solid rgba(255,255,255,0.06);
                            display:flex;flex-direction:column;background:rgba(0,0,0,0.15);">

                    <div style="text-align:center;margin-bottom:20px;">
                        <h1 class="menu-title" style="font-size:1.7rem;margin-bottom:3px;">âš”ï¸ SURVIVAL RPG</h1>
                        <p class="menu-subtitle" style="margin:0;font-size:10px;">ALPHA MULTIJUGADOR</p>
                    </div>

                    <div id="seed-section" style="background:rgba(61,220,132,0.05);border:1px solid rgba(61,220,132,0.18);border-radius:8px;padding:10px 12px;margin-bottom:12px;font-family:var(--font-ui);">
                        <span style="font-size:10px;color:#5a6475;letter-spacing:0.06em;text-transform:uppercase;display:block;margin-bottom:7px;">ğŸŒ Semilla del Mundo</span>
                        <div style="display:flex;gap:5px;align-items:center;margin-bottom:7px;">
                            <div style="flex:1;background:rgba(0,0,0,0.4);border:1px solid rgba(61,220,132,0.25);border-radius:6px;padding:6px 9px;display:flex;align-items:center;gap:5px;">
                                <span style="font-size:10px;color:#5a6475;">CÃ³digo:</span>
                                <span id="seed-display" style="font-family:monospace;font-size:15px;font-weight:700;letter-spacing:0.15em;color:#3ddc84;">-----</span>
                            </div>
                            <button id="btn-copy-seed" onclick="window.copySeedCode()" style="background:rgba(61,220,132,0.08);border:1px solid rgba(61,220,132,0.25);color:#3ddc84;border-radius:6px;padding:6px 9px;cursor:pointer;font-size:11px;font-family:var(--font-ui);" title="Copiar">ğŸ“‹</button>
                            <button id="btn-new-seed" onclick="window.resetSeed()" style="background:rgba(240,160,48,0.08);border:1px solid rgba(240,160,48,0.25);color:#f0a030;border-radius:6px;padding:6px 9px;cursor:pointer;font-size:11px;font-family:var(--font-ui);" title="Nueva">ğŸ”„</button>
                        </div>
                        <div style="display:flex;gap:5px;">
                            <input type="text" id="seed-input" class="menu-input" style="margin-bottom:0;flex:1;padding:6px 9px;font-family:monospace;letter-spacing:0.1em;text-transform:uppercase;font-size:12px;" placeholder="Ingresar cÃ³digoâ€¦" maxlength="8">
                            <button onclick="window.loadSeedCode()" style="background:rgba(91,180,245,0.08);border:1px solid rgba(91,180,245,0.25);color:#5bb4f5;border-radius:6px;padding:6px 10px;cursor:pointer;font-size:11px;font-family:var(--font-ui);white-space:nowrap;">Aplicar</button>
                        </div>
                        <div id="seed-status" style="font-size:9px;color:#5a6475;margin-top:3px;min-height:12px;font-family:var(--font-ui);"></div>
                    </div>

                    <input type="text" id="player-name" class="menu-input" placeholder="Tu nombre de supervivienteâ€¦" maxlength="15" style="margin-bottom:14px;">

                    <div style="display:flex;gap:5px;margin-bottom:0;">
                        <button id="tab-solo" onclick="window.showMenuTab('solo')" style="flex:1;padding:9px 6px;border-radius:7px;border:1px solid rgba(61,220,132,0.4);background:rgba(61,220,132,0.12);color:#3ddc84;font-family:var(--font-ui);font-size:12px;font-weight:700;cursor:pointer;letter-spacing:0.03em;">ğŸ•¹ï¸ Solo</button>
                        <button id="tab-multi" onclick="window.showMenuTab('multi')" style="flex:1;padding:9px 6px;border-radius:7px;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.03);color:#5a6475;font-family:var(--font-ui);font-size:12px;font-weight:700;cursor:pointer;letter-spacing:0.03em;">ğŸŒ Multijugador</button>
                    </div>

                    <div style="flex:1;"></div>

                    <div style="text-align:center;font-family:var(--font-ui);font-size:9px;color:rgba(90,100,117,0.5);letter-spacing:0.08em;margin-top:14px;">v0.1 ALPHA Â· SURVIVAL RPG</div>
                </div>

                <div style="flex:1;padding:28px 24px;display:flex;flex-direction:column;">

                    <div id="panel-solo" style="display:flex;flex-direction:column;height:100%;">
                        <div style="margin-bottom:16px;">
                            <h2 style="font-family:var(--font-display);font-size:13px;letter-spacing:0.12em;color:#3ddc84;text-transform:uppercase;margin:0 0 6px;">Modo Sin ConexiÃ³n</h2>
                            <p style="font-family:var(--font-ui);font-size:11px;color:#5a6475;margin:0;line-height:1.6;">JugÃ¡ solo en tu propia mundo. Sin servidores, sin internet.</p>
                        </div>
                        <button id="btn-single" class="action-btn" style="font-size:14px;padding:14px;margin-top:auto;">ğŸ•¹ï¸ Jugar Solo (Offline)</button>
                    </div>

                    <div id="panel-multi" style="display:none;flex-direction:column;gap:10px;">

                        <div style="background:rgba(61,220,132,0.05);border:1px solid rgba(61,220,132,0.2);border-radius:9px;padding:11px 13px;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;">
                                <span style="font-family:var(--font-ui);font-size:10px;color:#5a6475;text-transform:uppercase;letter-spacing:0.07em;">ğŸŒ Servidor Global</span>
                                <div id="server-status-badge" style="font-size:11px;font-weight:600;color:#f0a030;font-family:var(--font-ui);">ğŸŸ  Verificandoâ€¦</div>
                            </div>
                            <div id="global-server-stats" style="display:none;font-family:var(--font-ui);font-size:11px;color:#5a6475;margin-bottom:8px;gap:14px;">
                                <span>ğŸ‘¥ <span id="gstat-players">?</span> jugadores</span>
                                <span>ğŸŒ <span id="gstat-seed">?</span></span>
                                <span>ğŸ“¶ <span id="gstat-ping">?</span>ms</span>
                            </div>
                            <button id="btn-online" class="action-btn" style="margin-bottom:0;padding:10px;">ğŸŒ Unirse al Servidor Global</button>
                        </div>

                        <div style="background:rgba(91,180,245,0.05);border:1px solid rgba(91,180,245,0.18);border-radius:9px;padding:11px 13px;flex:1;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;">
                                <span style="font-family:var(--font-ui);font-size:10px;color:#5a6475;text-transform:uppercase;letter-spacing:0.07em;">ğŸŒ Salas Multijugador</span>
                                <button onclick="window.refreshServerList()" id="btn-refresh-servers" style="background:rgba(91,180,245,0.1);border:1px solid rgba(91,180,245,0.25);color:#5bb4f5;border-radius:5px;padding:3px 9px;cursor:pointer;font-size:10px;font-family:var(--font-ui);">â†º Actualizar</button>
                            </div>
                            <div id="server-list" style="display:flex;flex-direction:column;gap:4px;min-height:36px;max-height:120px;overflow-y:auto;margin-bottom:8px;">
                                <div id="server-list-empty" style="color:#5a6475;font-size:11px;font-family:var(--font-ui);text-align:center;padding:8px 0;">Ninguna sala encontrada. Â¡CreÃ¡ una abajo!</div>
                            </div>
                            <div style="display:flex;gap:6px;">
                                <input type="text" id="server-ip" class="menu-input" style="margin-bottom:0;flex:2;padding:8px 10px;font-size:12px;" placeholder="IP directa (ej: 192.168.1.5)â€¦">
                                <button id="btn-join" class="action-btn" style="flex:1;margin:0;padding:8px;border-color:rgba(91,180,245,0.3);color:#5bb4f5;background:linear-gradient(180deg,rgba(4,14,28,0.92),rgba(2,8,18,0.96));">Unirse</button>
                            </div>
                        </div>

                        <button id="btn-host" class="action-btn" style="padding:11px;border-color:rgba(240,160,48,0.3);color:#f0a030;background:linear-gradient(180deg,rgba(28,16,4,0.92),rgba(18,10,2,0.96));">
                            ğŸ  Crear Sala Multijugador
                        </button>

                        <div id="saved-servers" style="display:none;"></div>
                        <div id="online-url-area" style="display:none;"><span id="current-url"></span></div>
                    </div>

                </div>
            </div>
        </div>


        <div id="modal-create-room" style="display:none;position:absolute;inset:0;z-index:600;
             background:rgba(0,0,0,0.75);backdrop-filter:blur(4px);
             align-items:center;justify-content:center;">
            <div style="background:linear-gradient(155deg,rgba(10,16,24,0.99),rgba(6,10,18,0.995));
                        border:1px solid rgba(240,160,48,0.3);border-top:2px solid #f0a030;
                        border-radius:12px;padding:26px 26px 22px;width:340px;
                        box-shadow:0 30px 70px rgba(0,0,0,0.9);">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                    <h3 style="font-family:var(--font-display);font-size:14px;letter-spacing:0.1em;color:#f0a030;text-transform:uppercase;margin:0;">ğŸ  Crear Nueva Sala</h3>
                    <button onclick="window.closeCreateRoom()" style="background:transparent;border:none;color:#555;cursor:pointer;font-size:16px;" onmouseover="this.style.color='#f0a030'" onmouseout="this.style.color='#555'">âœ•</button>
                </div>
                <div style="margin-bottom:10px;">
                    <label style="font-family:var(--font-ui);font-size:10px;color:#5a6475;text-transform:uppercase;letter-spacing:0.07em;display:block;margin-bottom:5px;">Nombre de la sala</label>
                    <input type="text" id="room-name-input" class="menu-input" style="margin-bottom:0;" placeholder="Mi servidor Ã©picoâ€¦" maxlength="30">
                </div>
                <div style="margin-bottom:18px;">
                    <label style="font-family:var(--font-ui);font-size:10px;color:#5a6475;text-transform:uppercase;letter-spacing:0.07em;display:block;margin-bottom:5px;">Semilla (opcional â€” vacÃ­o = aleatoria)</label>
                    <input type="text" id="room-seed-input" class="menu-input" style="margin-bottom:0;font-family:monospace;text-transform:uppercase;letter-spacing:0.1em;" placeholder="Ej: A3F7Kâ€¦" maxlength="8">
                </div>
                <div id="create-room-error" style="display:none;background:rgba(220,60,60,0.1);border:1px solid rgba(220,60,60,0.3);border-radius:6px;padding:8px 10px;font-family:var(--font-ui);font-size:11px;color:#e07070;margin-bottom:10px;"></div>
                <button onclick="window.submitCreateRoom()" class="action-btn" style="border-color:rgba(240,160,48,0.35);color:#f0a030;background:linear-gradient(180deg,rgba(28,16,4,0.9),rgba(18,10,2,0.96));">
                    ğŸ  Crear Sala y Jugar
                </button>
            </div>
        </div>

        <canvas id="gameCanvas" width="1280" height="720" style="display:block;"></canvas>

        <div id="death-screen" class="glass-panel"
             style="display:none; position:absolute; top:50%; left:50%;
                    transform:translate(-50%,-50%); z-index:1000;
                    text-align:center; padding: 36px 40px; min-width: 300px;">
            <h2 style="color:#e05252; font-family: var(--font-display); font-size: 1.8rem;
                       letter-spacing: 0.12em; margin-bottom: 6px; text-shadow: 0 0 30px rgba(224,82,82,0.5);">
                Â¡HAS MUERTO!
            </h2>
            <p style="color: #5a6475; font-family: var(--font-ui); font-size: 12px;
                      letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 24px;">
                El mundo sigue sin tiâ€¦
            </p>
            <div style="display:flex; gap:12px; justify-content:center;">
                <button class="action-btn"
                        style="width:auto; padding: 10px 22px; font-size: 13px;"
                        onclick="window.respawn('coast')">ğŸŒŠ Costa</button>
                <button id="btn-respawn-bed" class="action-btn"
                        style="width:auto; padding: 10px 22px; font-size: 13px;
                               border-color: rgba(180,40,40,0.35); color: #e07070;
                               background: linear-gradient(180deg, rgba(22,4,4,0.9), rgba(14,2,2,0.96));"
                        onclick="window.respawn('bed')">ğŸ›ï¸ Tu Cama</button>
            </div>
        </div>

        <div id="ui-layer" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;">

            <div style="position:absolute; top:14px; left:14px; display:flex; flex-direction:column; gap:7px; z-index:200;">

                <div id="server-info" style="display:none; pointer-events:auto; align-items:center; gap:6px;
                     background:rgba(5,10,16,0.92); backdrop-filter:blur(14px);
                     border:1px solid rgba(61,220,132,0.25); border-left:2px solid #3ddc84;
                     border-radius:8px; padding:6px 12px;
                     font-family:var(--font-ui); font-size:12px; font-weight:600;
                     color:var(--text-main); letter-spacing:0.03em; white-space:nowrap;">
                    ğŸŸ¢ <span id="sv-ip" style="color:#3ddc84; font-weight:700;">Local</span>
                    <span style="color:rgba(255,255,255,0.2);">â”‚</span>
                    ğŸ‘¥ <span id="sv-players" style="color:#d8dde6; font-weight:700;">1</span><span style="color:#5a6475;">/10</span>
                    <span style="color:rgba(255,255,255,0.2);">â”‚</span>
                    <button onclick="window.togglePlayerList()"
                        style="background:linear-gradient(135deg,rgba(100,10,10,0.9),rgba(70,5,5,0.95));
                               color:#ff9090; border:1px solid rgba(200,50,50,0.4); border-radius:5px;
                               padding:3px 9px; cursor:pointer; font-size:11px; font-weight:700;
                               font-family:var(--font-ui); letter-spacing:0.03em; pointer-events:auto;"
                        onmouseover="this.style.background='linear-gradient(135deg,rgba(160,15,15,0.95),rgba(110,5,5,0.99))'"
                        onmouseout="this.style.background='linear-gradient(135deg,rgba(100,10,10,0.9),rgba(70,5,5,0.95))'">
                        âš”ï¸ Jugadores
                    </button>
                </div>

                <div id="pvp-player-panel"
                     style="display:none; pointer-events:auto; width:240px;
                            background:linear-gradient(155deg,rgba(12,3,3,0.97),rgba(7,2,2,0.99));
                            border:1px solid rgba(180,40,40,0.35); border-top:2px solid #c0392b;
                            border-radius:8px; overflow:hidden;
                            box-shadow:0 20px 50px rgba(0,0,0,0.85);">
                    <div style="padding:8px 12px 7px; border-bottom:1px solid rgba(180,40,40,0.2);
                                display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-family:var(--font-display); font-size:11px; letter-spacing:0.1em;
                                     color:#e07070; text-transform:uppercase; font-weight:700;">âš” Duelos PVP</span>
                        <button onclick="window.togglePlayerList()"
                            style="background:transparent; border:none; color:#555; cursor:pointer;
                                   font-size:14px; line-height:1; padding:0 2px; pointer-events:auto;"
                            onmouseover="this.style.color='#e07070'" onmouseout="this.style.color='#555'">âœ•</button>
                    </div>
                    <div id="pvp-player-list-inner" style="padding:8px 10px; max-height:220px; overflow-y:auto;">
                        <div style="color:#5a6475; font-size:12px; text-align:center; padding:14px 0;
                                    font-family:var(--font-ui);">Sin jugadores en lÃ­nea</div>
                    </div>
                </div>

                <div id="distance-display" style="pointer-events:none;">
                    ğŸ—ºï¸ Costa: <span id="dist-text" style="color:#f5c842;">0m</span>
                </div>
                <div id="entity-hud" style="display:flex; flex-direction:column; gap:6px; pointer-events:none;"></div>
            </div>

            <div id="clock-display">DÃ­a 1 â€” 08:00</div>

            <div id="server-menu-panel" style="display:none;position:absolute;top:50px;right:18px;z-index:600;pointer-events:auto;
                 background:rgba(8,12,20,0.97);backdrop-filter:blur(16px);
                 border:1px solid rgba(240,160,48,0.3);border-top:2px solid #f0a030;border-radius:10px;
                 min-width:270px;overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,0.85);">
                <div style="padding:11px 16px 9px;border-bottom:1px solid rgba(240,160,48,0.12);display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-family:var(--font-display);font-size:12px;letter-spacing:0.12em;color:#f0a030;text-transform:uppercase;font-weight:700;">â˜° Servidor</span>
                    <button onclick="window.toggleServerMenu()" style="background:transparent;border:none;color:#555;cursor:pointer;font-size:14px;padding:0 2px;pointer-events:auto;" onmouseover="this.style.color='#f0a030'" onmouseout="this.style.color='#555'">âœ•</button>
                </div>
                <div id="server-menu-info" style="padding:9px 16px;border-bottom:1px solid rgba(255,255,255,0.05);font-family:var(--font-ui);font-size:11px;color:#5a6475;line-height:1.7;"></div>
                <div style="padding:10px 12px;display:flex;flex-direction:column;gap:7px;">
                    <button onclick="window.copyInviteLink()" style="width:100%;padding:10px 14px;border-radius:7px;border:1px solid rgba(61,220,132,0.3);background:rgba(61,220,132,0.08);color:#3ddc84;font-family:var(--font-ui);font-size:12px;font-weight:700;cursor:pointer;letter-spacing:0.03em;pointer-events:auto;">
                        ğŸ”— Copiar Link de InvitaciÃ³n
                    </button>
                    <div id="invite-link-display" style="display:none;background:rgba(0,0,0,0.45);border:1px solid rgba(61,220,132,0.2);border-radius:6px;padding:8px 10px;font-family:monospace;font-size:10px;color:#3ddc84;word-break:break-all;line-height:1.5;"></div>
                    <button onclick="window.leaveServer()" style="width:100%;padding:10px 14px;border-radius:7px;border:1px solid rgba(220,60,60,0.3);background:rgba(220,60,60,0.07);color:#e07070;font-family:var(--font-ui);font-size:12px;font-weight:700;cursor:pointer;letter-spacing:0.03em;pointer-events:auto;">
                        ğŸšª Salir del Servidor
                    </button>
                </div>
            </div>

            <div style="position:absolute; top:18px; right:18px; display:flex; flex-direction:column; gap:10px; align-items:flex-end; pointer-events:none; z-index:200; width:290px;">

                <div id="top-controls" style="display:flex; gap:5px; pointer-events:auto;">
                    <button class="toggle-btn" onclick="window.openChat()" style="color:#5bb4f5;">ğŸ’¬</button>
                    <button class="toggle-btn" onclick="window.toggleChatLog()" style="color:#a478f0;">ğŸ“œ</button>
                    <div style="position:relative; display:inline-block;">
                        <button class="toggle-btn" onclick="window.toggleMenu('inventory')" style="pointer-events:auto;">
                            ğŸ‘¤ Personaje
                        </button>
                        <span id="stat-notif" class="stat-notif">!</span>
                    </div>
                    <button class="toggle-btn" onclick="window.toggleMenu('crafting')">âš’ï¸ Crafteo</button>
                    <button id="btn-server-menu" class="toggle-btn" onclick="window.toggleServerMenu()" style="display:none; color:#f0a030; border-color:rgba(240,160,48,0.35); background:linear-gradient(180deg,rgba(28,16,4,0.85),rgba(18,10,2,0.9));">â˜° Sala</button>
                    <button id="btn-help" class="toggle-btn" style="padding: 5px 8px;">?</button>
                </div>

                <div id="status-bars" style="display:flex; flex-direction:column; gap:7px; width:220px; pointer-events:auto; background: rgba(4,8,14,0.75); backdrop-filter: blur(12px); padding: 10px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.07);">
                    <div class="bar-wrapper">
                        <div class="bar-label"><span>â¤ï¸ Salud</span><span id="hp-text">100/100</span></div>
                        <div class="bar-container"><div id="hp-fill" class="bar-fill" style="width:100%;"></div></div>
                    </div>
                    <div class="bar-wrapper">
                        <div class="bar-label"><span>ğŸ– EnergÃ­a</span><span id="hunger-text">100/100</span></div>
                        <div class="bar-container"><div id="hunger-fill" class="bar-fill" style="width:100%;"></div></div>
                    </div>
                    <div class="bar-wrapper">
                        <div class="bar-label">
                            <span class="level-text-highlight">â­ Niv. <span id="level-text">1</span></span>
                            <span id="xp-text">0/100</span>
                        </div>
                        <div class="bar-container"><div id="xp-fill" class="bar-fill" style="width:0%;"></div></div>
                    </div>
                </div>

                <div id="global-chat-log" style="display:flex; flex-direction:column; gap:4px; width:100%; align-items:flex-end; text-align:right; pointer-events:none;"></div>
            </div>

            <div id="toolbar"></div>

            <div id="chat-container"
                 style="display:none; position:absolute; bottom:80px; left:50%;
                        transform:translateX(-50%); width:420px; z-index:2000; pointer-events:auto;">
                <input type="text" id="chat-input"
                       placeholder="Escribe un mensajeâ€¦ (Enter para enviar)"
                       autocomplete="off"
                       style="width:100%; padding: 11px 16px; border-radius: 8px;
                              border: 1px solid rgba(61,220,132,0.35);
                              background: rgba(3,6,12,0.96);
                              backdrop-filter: blur(14px);
                              color: #eef2ff;
                              font-family: var(--font-ui);
                              font-size: 13px; font-weight: 500;
                              outline: none; text-align: center;
                              box-shadow: 0 8px 28px rgba(0,0,0,0.7), 0 0 0 3px rgba(61,220,132,0.07);">
            </div>

            <div id="interaction-prompt"><span id="prompt-text"></span></div>

            <div id="placement-overlay"
                 style="display:none; position:absolute; top:60%; left:50%;
                        transform:translate(-50%,-50%); text-align:center; pointer-events:none;">
                MODO UBICACIÃ“N
                <br>
                <span style="font-family: var(--font-ui); font-size: 11px; font-weight:500; color:#5a6475; letter-spacing:0.06em;">
                    Clic Izq: Colocar &nbsp;Â·&nbsp; Clic Der: Cancelar
                </span>
            </div>

            <div id="game-tips" class="glass-panel"
                 style="display:none; position:absolute; top:70px; left:50%;
                        transform:translateX(-50%); pointer-events:auto; z-index:300;">
                <strong style="color:#f5c842; font-family: var(--font-display); font-size: 0.8rem; letter-spacing:0.12em;">
                    CONTROLES
                </strong>
                <br><br>
                <span class="tip-highlight">ENTER</span> Abrir / enviar chat<br>
                <span class="tip-highlight">F</span> Comer rÃ¡pido<br>
                <span class="tip-highlight">E</span> Interactuar (puertas, cajas, fogatas)<br>
                <span class="tip-highlight">SHIFT</span> + estar adentro = <b style="color:#a478f0;">SIGILO</b><br>
                <span class="tip-highlight">R</span> Cambiar modo martillo<br>
                <span class="tip-highlight">1â€“6</span> Seleccionar cinturÃ³n<br>
                <span class="tip-highlight">Y</span> (mantener) Atraer Ã­tems
            </div>

            <div id="menu-inventory" class="window-menu" style="pointer-events:auto; min-width:420px;">
                <div class="window-header">
                    <h3>ğŸ‘¤ Personaje</h3>
                    <button class="close-btn" onclick="window.toggleMenu('inventory')">âœ•</button>
                </div>
                <div class="inv-split">
                    <div class="inv-left">
                        <div style="font-size:10px; color:#5a6475; margin-bottom:8px; text-align:center; font-family:var(--font-ui); letter-spacing:0.08em; text-transform:uppercase;">
                            Mochila â€” arrastra al cinturÃ³n
                        </div>
                        <div id="inventory-grid"></div>
                    </div>
                    <div class="inv-right">
                        <div class="stat-header">Atributos &nbsp;<span style="color:#5a6475; font-size:0.7rem;">(Puntos: <span id="stat-points">0</span>)</span></div>
                        <div class="stat-row">
                            <span>ğŸ’ª Fuerza</span>
                            <div style="display:flex; align-items:center;">
                                <span class="stat-val" id="stat-str">0</span>
                                <button class="stat-btn" onclick="window.upgradeStat('str')">+</button>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span>âš¡ Agilidad</span>
                            <div style="display:flex; align-items:center;">
                                <span class="stat-val" id="stat-agi">0</span>
                                <button class="stat-btn" onclick="window.upgradeStat('agi')">+</button>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span>â¤ï¸ Vitalidad</span>
                            <div style="display:flex; align-items:center;">
                                <span class="stat-val" id="stat-vit">0</span>
                                <button class="stat-btn" onclick="window.upgradeStat('vit')">+</button>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span>ğŸ¥© Stamina</span>
                            <div style="display:flex; align-items:center;">
                                <span class="stat-val" id="stat-sta">0</span>
                                <button class="stat-btn" onclick="window.upgradeStat('sta')">+</button>
                            </div>
                        </div>
                        <div class="stat-row">
                            <span>ğŸ§  Intelecto</span>
                            <div style="display:flex; align-items:center;">
                                <span class="stat-val" id="stat-int">0</span>
                                <button class="stat-btn" onclick="window.upgradeStat('int')">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="menu-box" class="window-menu" style="pointer-events:auto;">
                <div class="window-header">
                    <h3 id="box-dynamic-header">ğŸ“¦ Cofre</h3>
                    <button class="close-btn" onclick="window.toggleMenu('box')">âœ•</button>
                </div>
                <div class="inv-split">
                    <div class="inv-left">
                        <div style="font-size:10px; color:#5a6475; margin-bottom:8px; font-family:var(--font-ui); letter-spacing:0.08em; text-transform:uppercase;">Tu mochila</div>
                        <div class="inv-grid" id="box-player-grid"></div>
                    </div>
                    <div class="inv-right">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <div style="font-size:10px; color:#5a6475; font-family:var(--font-ui); letter-spacing:0.08em; text-transform:uppercase;">Contenido</div>
                            <button id="btn-take-all-box" class="action-btn mini" style="font-size:10px; padding:3px 8px;" onclick="window.takeAllFromBox()">Agarrar todo</button>
                        </div>
                        <div class="inv-grid" id="box-storage-grid"></div>
                    </div>
                </div>
                <div style="font-size:10px; color:#5a6475; text-align:center; margin-top:8px; font-family:var(--font-ui);">
                    ğŸ–±ï¸ Clic = mover 1 &nbsp;Â·&nbsp; Clic derecho = mover 10
                </div>
            </div>

            <div id="menu-campfire" class="window-menu" style="pointer-events:auto; min-width:260px;">
                <div class="window-header">
                    <h3>ğŸ”¥ Fogata</h3>
                    <button class="close-btn" onclick="window.toggleMenu('campfire')">âœ•</button>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding: 8px 10px; background: rgba(0,0,0,0.3); border-radius: 6px; border: 1px solid rgba(255,255,255,0.05);">
                    <span style="font-weight:600;">ğŸªµ Madera</span>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <strong id="cf-wood-count" style="color:var(--gold); min-width:20px; text-align:center;">0</strong>
                        <button class="action-btn mini" onclick="window.cfAction('addWood')">+ AÃ±adir</button>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding: 8px 10px; background: rgba(0,0,0,0.3); border-radius: 6px; border: 1px solid rgba(255,255,255,0.05);">
                    <span style="font-weight:600;">ğŸ¥© Carne Cruda</span>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <strong id="cf-meat-count" style="color:var(--gold); min-width:20px; text-align:center;">0</strong>
                        <button class="action-btn mini" onclick="window.cfAction('addMeat')">+ AÃ±adir</button>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; padding: 8px 10px; background: rgba(61,220,132,0.04); border-radius: 6px; border: 1px solid rgba(61,220,132,0.1);">
                    <span style="font-weight:600; color:var(--green);">ğŸ– Carne Asada</span>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <strong id="cf-cooked-count" style="color:var(--green); min-width:20px; text-align:center;">0</strong>
                        <button class="action-btn mini" onclick="window.cfAction('takeCooked')">Recoger</button>
                    </div>
                </div>
                <button id="btn-cf-ignite" class="action-btn"
                        style="border-color:rgba(240,160,48,0.3); color:var(--amber);
                               background:linear-gradient(180deg, rgba(28,16,4,0.92), rgba(18,10,2,0.96));
                               text-shadow: 0 0 12px rgba(240,160,48,0.3);"
                        onclick="window.cfAction('toggleFire')">
                    ğŸ”¥ ENCENDER
                </button>
            </div>

            <div id="menu-crafting" class="window-menu" style="pointer-events:auto; min-width:340px;">
                <div class="window-header">
                    <h3>âš’ï¸ Mesa de Trabajo</h3>
                    <button class="close-btn" onclick="window.toggleMenu('crafting')">âœ•</button>
                </div>
                <div class="craft-tabs">
                    <button id="btn-tab-herramientas" class="action-btn mini"
                            style="flex:1; border-color:rgba(61,220,132,0.35); color:var(--green);"
                            onclick="window.switchCraftTab('herramientas')">ğŸ› ï¸ Herram.</button>
                    <button id="btn-tab-armas" class="action-btn mini"
                            style="flex:1;"
                            onclick="window.switchCraftTab('armas')">âš”ï¸ Armas</button>
                    <button id="btn-tab-muebles" class="action-btn mini"
                            style="flex:1;"
                            onclick="window.switchCraftTab('muebles')">ğŸ  Muebles</button>
                </div>
                <input type="text" id="craft-search" class="search-bar" placeholder="ğŸ” Buscar recetaâ€¦">
                <div id="craft-list">
                    <div id="tab-herramientas">
                        <div class="craft-item" data-name="antorcha luz">
                            <div class="craft-header">
                                <span class="craft-title">ğŸ”¥ Antorcha</span>
                                <span id="req-torch" class="req-text"></span>
                            </div>
                            <button id="btn-craft-torch" class="action-btn mini">Fabricar Â· 5 Mad. + 2 Tela</button>
                        </div>
                        <div class="craft-item" data-name="hacha">
                            <div class="craft-header">
                                <span class="craft-title">ğŸª“ Hacha</span>
                                <span id="req-axe" class="req-text"></span>
                            </div>
                            <button id="btn-craft-axe" class="action-btn mini">Fabricar Â· 10 Mad.</button>
                        </div>
                        <div class="craft-item" data-name="pico">
                            <div class="craft-header">
                                <span class="craft-title">â›ï¸ Pico</span>
                                <span id="req-pickaxe" class="req-text"></span>
                            </div>
                            <button id="btn-craft-pickaxe" class="action-btn mini">Fabricar Â· 20 Mad.</button>
                        </div>
                        <div class="craft-item" data-name="martillo">
                            <div class="craft-header">
                                <span class="craft-title">ğŸ”¨ Martillo</span>
                                <span id="req-hammer" class="req-text"></span>
                            </div>
                            <button id="btn-craft-hammer" class="action-btn mini">Fabricar Â· 15 Mad.</button>
                        </div>
                    </div>
                    <div id="tab-armas" style="display:none;">
                        <div class="craft-item" data-name="arco">
                            <div class="craft-header">
                                <span class="craft-title">ğŸ¹ Arco Corto</span>
                                <span id="req-bow" class="req-text"></span>
                            </div>
                            <button id="btn-craft-bow" class="action-btn mini">Fabricar Â· 100 Mad. + 2 Tela</button>
                        </div>
                        <div class="craft-item" data-name="espada">
                            <div class="craft-header">
                                <span class="craft-title">âš”ï¸ Espada</span>
                                <span id="req-sword" class="req-text"></span>
                            </div>
                            <button id="btn-craft-sword" class="action-btn mini">Fabricar Â· 30 Mad. + 30 Pie.</button>
                        </div>
                        <div class="craft-item" data-name="flechas municion">
                            <div class="craft-header">
                                <span class="craft-title">ğŸ¯ Flechas</span>
                                <span class="req-text req-text-ok">5 Mad. c/u</span>
                            </div>
                            <div class="craft-actions">
                                <button id="btn-craft-arrow"  class="action-btn mini">Ã—1</button>
                                <button id="btn-craft-arrow2" class="action-btn mini">Ã—2</button>
                                <button id="btn-craft-arrow5" class="action-btn mini">Ã—5</button>
                                <button id="btn-craft-arrow10" class="action-btn mini">Ã—10</button>
                            </div>
                        </div>
                    </div>
                    <div id="tab-muebles" style="display:none;">
                        <div class="craft-item" data-name="caja cofre">
                            <div class="craft-header">
                                <span class="craft-title">ğŸ“¦ Caja</span>
                                <span id="req-box" class="req-text"></span>
                            </div>
                            <button id="btn-craft-box" class="action-btn mini">Fabricar Â· 40 Mad.</button>
                        </div>
                        <div class="craft-item" data-name="fogata fuego">
                            <div class="craft-header">
                                <span class="craft-title">ğŸ”¥ Fogata</span>
                                <span id="req-campfire" class="req-text"></span>
                            </div>
                            <button id="btn-craft-campfire" class="action-btn mini">Fabricar Â· 20 Mad. + 5 Pie.</button>
                        </div>
                        <div class="craft-item" data-name="cama dormir spawn">
                            <div class="craft-header">
                                <span class="craft-title">ğŸ›ï¸ Cama (Respawn)</span>
                                <span id="req-bed" class="req-text"></span>
                            </div>
                            <button id="btn-craft-bed" class="action-btn mini">Fabricar Â· 30 Mad. + 10 Tela</button>
                        </div>
                        <div class="craft-item" data-name="barricada puas trampa defensa">
                            <div class="craft-header">
                                <span class="craft-title">ğŸª¤ Barricada con PÃºas</span>
                                <span id="req-barricade" class="req-text"></span>
                            </div>
                            <button id="btn-craft-barricade" class="action-btn mini">Fabricar Â· 8 Mad. + 4 Pie.</button>
                        </div>
                        <div class="craft-item" data-name="escalera trepar subir bloque">
                            <div class="craft-header">
                                <span class="craft-title">ğŸªœ Escalera</span>
                                <span id="req-ladder" class="req-text"></span>
                            </div>
                            <div class="craft-actions">
                                <button id="btn-craft-ladder1" class="action-btn mini">Ã—1 Â· 6 Mad.</button>
                                <button id="btn-craft-ladder5" class="action-btn mini">Ã—5 Â· 30 Mad.</button>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div></div></div><script>
    function resizeGame() {
        const wrapper = document.getElementById('game-wrapper');
        const scale = Math.min(window.innerWidth / 1280, window.innerHeight / 720);
        wrapper.style.transform = `scale(${scale})`;
    }
    window.addEventListener('resize', resizeGame);
    window.addEventListener('DOMContentLoaded', resizeGame);
</script>

<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
<script src="data.js"></script>
<script src="terrain.js"></script>
<script src="inventory.js"></script>
<script src="physics.js"></script>
<script src="entities.js"></script>
<script src="player.js"></script>
<script src="ui.js"></script>
<script src="render_character.js"></script>
<script src="render_world.js"></script>
<script src="game.js"></script>

<script>
// ============================================================
//  SISTEMA DE SONIDO â€” Web Audio API, sin archivos externos
//  El AudioContext se precalienta en el primer gesto para
//  eliminar el delay que causa la polÃ­tica de autoplay.
// ============================================================
(function() {
    // Crear el contexto de audio inmediatamente (puede quedar suspendido)
    let _ctx;
    try { _ctx = new (window.AudioContext || window.webkitAudioContext)(); } catch(e) { window.playSound = () => {}; return; }

    let _ready = false;
    const _last = {};
    const THROTTLE = {
        hit_tree:130, hit_rock:110, hit_block:120, hit_entity:90,
        player_hit:180, arrow_shoot:80, arrow_stick:120, arrow_break:100,
        arrow_hit_flesh:100, door:350, pickup:70, craft:400,
        level_up:600, menu_open:200, build:180, eat:500,
        jump:250, land:200, enemy_die:200, tree_fall:300
    };

    // Precalentamiento: en el primer click/tecla, resumir el contexto
    // y reproducir un buffer silencioso para "desbloquear" el sistema
    function warmUp() {
        if (_ready) return;
        _ctx.resume().then(() => {
            // Buffer silencioso de 1 frame para inicializar el pipeline de audio
            const buf = _ctx.createBuffer(1, 1, _ctx.sampleRate);
            const src = _ctx.createBufferSource();
            src.buffer = buf;
            src.connect(_ctx.destination);
            src.start(0);
            _ready = true;
        });
    }
    // Enganchar en los primeros gestos posibles
    ['mousedown','keydown','touchstart','click'].forEach(ev =>
        document.addEventListener(ev, warmUp, { once: false, passive: true })
    );

    // --- Helpers ------------------------------------------------
    function noise(dur) {
        const n = Math.ceil(_ctx.sampleRate * dur);
        const b = _ctx.createBuffer(1, n, _ctx.sampleRate);
        const d = b.getChannelData(0);
        for (let i = 0; i < n; i++) d[i] = Math.random() * 2 - 1;
        return b;
    }
    function gain(vol, dur) {
        const g = _ctx.createGain();
        g.gain.setValueAtTime(vol, _ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.0001, _ctx.currentTime + dur);
        g.connect(_ctx.destination);
        return g;
    }
    function throttled(type) {
        const now = Date.now();
        if (_last[type] && now - _last[type] < (THROTTLE[type] || 80)) return false;
        _last[type] = now;
        return true;
    }

    // --- Motor de sonido ----------------------------------------
    function play(type) {
        if (!_ready || !throttled(type)) return;
        const t = _ctx.currentTime;

        if (type === 'hit_tree') {
            const buf = noise(0.20); const d = buf.getChannelData(0);
            for (let i = 0; i < d.length; i++) { const s=i/_ctx.sampleRate; d[i]=d[i]*Math.exp(-s*26)*0.65+Math.sin(2*Math.PI*110*s)*Math.exp(-s*18)*0.4+Math.sin(2*Math.PI*62*s)*Math.exp(-s*14)*0.28; }
            const src=_ctx.createBufferSource(); src.buffer=buf;
            const lpf=_ctx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=820;
            src.connect(lpf); lpf.connect(gain(0.55,0.22)); src.start();

        } else if (type === 'hit_rock') {
            const buf = noise(0.20); const d = buf.getChannelData(0);
            for (let i = 0; i < d.length; i++) { const s=i/_ctx.sampleRate; d[i]=d[i]*Math.exp(-s*50)*0.25+Math.sin(2*Math.PI*700*s)*Math.exp(-s*38)*0.58+Math.sin(2*Math.PI*1280*s)*Math.exp(-s*54)*0.28; }
            const src=_ctx.createBufferSource(); src.buffer=buf;
            const hpf=_ctx.createBiquadFilter(); hpf.type='highpass'; hpf.frequency.value=360;
            src.connect(hpf); hpf.connect(gain(0.48,0.22)); src.start();

        } else if (type === 'hit_block') {
            const buf = noise(0.15); const d = buf.getChannelData(0);
            for (let i = 0; i < d.length; i++) { const s=i/_ctx.sampleRate; d[i]=d[i]*Math.exp(-s*38)*0.62+Math.sin(2*Math.PI*185*s)*Math.exp(-s*22)*0.38; }
            const src=_ctx.createBufferSource(); src.buffer=buf;
            const lpf=_ctx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=700;
            src.connect(lpf); lpf.connect(gain(0.40,0.16)); src.start();

        } else if (type === 'hit_entity') {
            const buf = noise(0.12); const d = buf.getChannelData(0);
            for (let i = 0; i < d.length; i++) { const s=i/_ctx.sampleRate; d[i]=d[i]*Math.exp(-s*56)*0.78+Math.sin(2*Math.PI*225*s)*Math.exp(-s*40)*0.28; }
            const src=_ctx.createBufferSource(); src.buffer=buf;
            const bpf=_ctx.createBiquadFilter(); bpf.type='bandpass'; bpf.frequency.value=520; bpf.Q.value=1.4;
            src.connect(bpf); bpf.connect(gain(0.52,0.13)); src.start();

        } else if (type === 'player_hit') {
            const buf = noise(0.24); const d = buf.getChannelData(0);
            for (let i = 0; i < d.length; i++) { const s=i/_ctx.sampleRate; d[i]=d[i]*Math.exp(-s*17)*0.88+Math.sin(2*Math.PI*80*s)*Math.exp(-s*13)*0.48; }
            const src=_ctx.createBufferSource(); src.buffer=buf;
            const lpf=_ctx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=760;
            src.connect(lpf); lpf.connect(gain(0.65,0.26)); src.start();

        } else if (type === 'enemy_die') {
            const osc=_ctx.createOscillator(); osc.type='sawtooth';
            osc.frequency.setValueAtTime(250,t); osc.frequency.exponentialRampToValueAtTime(55,t+0.30);
            osc.connect(gain(0.22,0.33)); osc.start(t); osc.stop(t+0.33);

        } else if (type === 'arrow_shoot') {
            const osc=_ctx.createOscillator(); osc.type='sawtooth';
            osc.frequency.setValueAtTime(700,t); osc.frequency.exponentialRampToValueAtTime(2500,t+0.09);
            const lpf=_ctx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=3200;
            osc.connect(lpf); lpf.connect(gain(0.16,0.10)); osc.start(t); osc.stop(t+0.10);

        } else if (type === 'arrow_stick') {
            const buf=noise(0.10); const d=buf.getChannelData(0);
            for (let i=0;i<d.length;i++){const s=i/_ctx.sampleRate;d[i]=d[i]*Math.exp(-s*76)*0.52+Math.sin(2*Math.PI*315*s)*Math.exp(-s*50)*0.48;}
            const src=_ctx.createBufferSource(); src.buffer=buf;
            const bpf=_ctx.createBiquadFilter(); bpf.type='bandpass'; bpf.frequency.value=860; bpf.Q.value=2.8;
            src.connect(bpf); bpf.connect(gain(0.38,0.11)); src.start();

        } else if (type === 'arrow_break') {
            const buf=noise(0.07); const d=buf.getChannelData(0);
            for (let i=0;i<d.length;i++) d[i]*=Math.exp(-(i/_ctx.sampleRate)*95)*0.7;
            const src=_ctx.createBufferSource(); src.buffer=buf;
            const hpf=_ctx.createBiquadFilter(); hpf.type='highpass'; hpf.frequency.value=1900;
            src.connect(hpf); hpf.connect(gain(0.26,0.07)); src.start();

        } else if (type === 'arrow_hit_flesh') {
            const buf=noise(0.11); const d=buf.getChannelData(0);
            for (let i=0;i<d.length;i++){const s=i/_ctx.sampleRate;d[i]=d[i]*Math.exp(-s*60)*0.82+Math.sin(2*Math.PI*165*s)*Math.exp(-s*46)*0.20;}
            const src=_ctx.createBufferSource(); src.buffer=buf;
            const lpf=_ctx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=1280;
            src.connect(lpf); lpf.connect(gain(0.50,0.11)); src.start();

        } else if (type === 'door') {
            const osc=_ctx.createOscillator(); osc.type='sawtooth';
            osc.frequency.setValueAtTime(340,t); osc.frequency.exponentialRampToValueAtTime(72,t+0.27);
            const buf2=noise(0.27); const d2=buf2.getChannelData(0);
            for(let i=0;i<d2.length;i++) d2[i]*=Math.exp(-(i/_ctx.sampleRate)*14)*0.28;
            const src2=_ctx.createBufferSource(); src2.buffer=buf2;
            const lpf=_ctx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=600;
            const g=gain(0.28,0.30);
            osc.connect(lpf); lpf.connect(g); src2.connect(g);
            osc.start(t); osc.stop(t+0.30); src2.start(t);

        } else if (type === 'build') {
            [0,0.07].forEach((delay,i)=>{
                const buf=noise(0.10); const d=buf.getChannelData(0);
                for(let j=0;j<d.length;j++){const s=j/_ctx.sampleRate;d[j]=d[j]*Math.exp(-s*44)*0.58+Math.sin(2*Math.PI*(158+i*38)*s)*Math.exp(-s*28)*0.38;}
                const src=_ctx.createBufferSource(); src.buffer=buf;
                const lpf=_ctx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=880;
                const g=_ctx.createGain(); g.gain.setValueAtTime(0.34,t+delay); g.gain.exponentialRampToValueAtTime(0.0001,t+delay+0.11);
                g.connect(_ctx.destination); src.connect(lpf); lpf.connect(g); src.start(t+delay);
            });

        } else if (type === 'pickup') {
            const osc=_ctx.createOscillator(); osc.type='sine';
            osc.frequency.setValueAtTime(900,t); osc.frequency.setValueAtTime(1350,t+0.04);
            osc.connect(gain(0.18,0.14)); osc.start(t); osc.stop(t+0.14);

        } else if (type === 'craft') {
            [[660,0],[990,0.10]].forEach(([freq,delay])=>{
                const osc=_ctx.createOscillator(); osc.type='triangle'; osc.frequency.value=freq;
                const g=_ctx.createGain(); g.gain.setValueAtTime(0.17,t+delay); g.gain.exponentialRampToValueAtTime(0.0001,t+delay+0.13);
                osc.connect(g); g.connect(_ctx.destination); osc.start(t+delay); osc.stop(t+delay+0.13);
            });

        } else if (type === 'level_up') {
            [[523,0],[659,0.13],[784,0.26],[1047,0.40]].forEach(([freq,delay])=>{
                const osc=_ctx.createOscillator(); osc.type='square'; osc.frequency.value=freq;
                const g=_ctx.createGain(); g.gain.setValueAtTime(0.14,t+delay); g.gain.exponentialRampToValueAtTime(0.0001,t+delay+0.20);
                osc.connect(g); g.connect(_ctx.destination); osc.start(t+delay); osc.stop(t+delay+0.20);
            });

        } else if (type === 'menu_open') {
            const osc=_ctx.createOscillator(); osc.type='sine';
            osc.frequency.setValueAtTime(420,t); osc.frequency.exponentialRampToValueAtTime(660,t+0.09);
            osc.connect(gain(0.11,0.13)); osc.start(t); osc.stop(t+0.13);

        } else if (type === 'eat') {
            [0,0.08,0.16].forEach(delay=>{
                const buf=noise(0.06); const d=buf.getChannelData(0);
                for(let i=0;i<d.length;i++) d[i]*=Math.exp(-(i/_ctx.sampleRate)*78)*0.5;
                const src=_ctx.createBufferSource(); src.buffer=buf;
                const bpf=_ctx.createBiquadFilter(); bpf.type='bandpass'; bpf.frequency.value=580; bpf.Q.value=2;
                const g=_ctx.createGain(); g.gain.setValueAtTime(0.24,t+delay); g.gain.exponentialRampToValueAtTime(0.0001,t+delay+0.06);
                g.connect(_ctx.destination); src.connect(bpf); bpf.connect(g); src.start(t+delay);
            });

        } else if (type === 'jump') {
            const osc=_ctx.createOscillator(); osc.type='sine';
            osc.frequency.setValueAtTime(200,t); osc.frequency.exponentialRampToValueAtTime(420,t+0.12);
            osc.connect(gain(0.09,0.14)); osc.start(t); osc.stop(t+0.14);

        } else if (type === 'land') {
            const buf=noise(0.14); const d=buf.getChannelData(0);
            for(let i=0;i<d.length;i++){const s=i/_ctx.sampleRate;d[i]=d[i]*Math.exp(-s*30)*0.62+Math.sin(2*Math.PI*88*s)*Math.exp(-s*24)*0.32;}
            const src=_ctx.createBufferSource(); src.buffer=buf;
            const lpf=_ctx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=660;
            src.connect(lpf); lpf.connect(gain(0.38,0.15)); src.start();

        } else if (type === 'tree_fall') {
            const buf=noise(0.45); const d=buf.getChannelData(0);
            for(let i=0;i<d.length;i++){const s=i/_ctx.sampleRate;const env=s<0.3?Math.exp(-s*5):Math.exp(-(s-0.3)*18)*0.75;d[i]=d[i]*env*0.68+Math.sin(2*Math.PI*52*s)*env*0.48;}
            const src=_ctx.createBufferSource(); src.buffer=buf;
            const lpf=_ctx.createBiquadFilter(); lpf.type='lowpass'; lpf.frequency.value=580;
            src.connect(lpf); lpf.connect(gain(0.55,0.46)); src.start();
        }
    }

    window.playSound = play;

    // --- Hooks automÃ¡ticos en funciones del juego ---------------
    // Esperamos a que los scripts del juego hayan cargado
    window.addEventListener('load', () => {
        // damagePlayer â†’ player_hit
        const _dmg = window.damagePlayer;
        if (_dmg) window.damagePlayer = function(a,s){ play('player_hit'); return _dmg(a,s); };

        // gainXP â†’ level_up si subiÃ³ de nivel
        const _xp = window.gainXP;
        if (_xp) window.gainXP = function(a){ const prev=window.player?window.player.level:0; _xp(a); if(window.player&&window.player.level>prev) play('level_up'); };

        // craftItem â†’ craft
        const _cr = window.craftItem;
        if (_cr) window.craftItem = function(...a){ _cr(...a); play('craft'); };

        // eatFood â†’ eat
        const _eat = window.eatFood;
        if (_eat) window.eatFood = function(...a){ _eat(...a); play('eat'); };

        // sendWorldUpdate â†’ tree_fall / enemy_die
        const _sw = window.sendWorldUpdate;
        if (_sw) window.sendWorldUpdate = function(action, payload){
            if (action==='destroy_tree') play('tree_fall');
            if (action==='kill_entity') play('enemy_die');
            return _sw(action, payload);
        };

        // Salto y aterrizaje via update loop
        const _upd = window.update;
        if (_upd) window.update = function(){
            const wasG = window.player ? window.player.isGrounded : false;
            _upd();
            if (!window.player) return;
            if (!wasG && window.player.isGrounded && (window.player._prevVy||0) > 4) play('land');
            window.player._prevVy = window.player.vy || 0;
        };

        // Tecla de salto
        document.addEventListener('keydown', (e) => {
            if ((e.key===' '||e.key==='w'||e.key==='W') && window.player && window.player.isGrounded && !window.player.isDead)
                play('jump');
        });
    });
})();
</script>

</body>
</html>